<!--python -m http.server-->
<!--TODO SCALE LES CIRCLES ET UPDATE LES RONDS QUI SONT SOUS LA MAP?-->
<!--TODO GEOJSON ELARGI DE NYC?-->

<!DOCTYPE html>
<head>


  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/queue.v1.min.js"></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <style>
      body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }

      .regions {
          stroke: #fff;
          stroke-width: 2px;
      }

      .regions:hover {
          fill: #666;
      }

      .hidden {
          display: none;
      }

      .enter {
          /*fill: green;*/
      }

      .update {
        /*fill: #333;*/
      }

      /* le tooltip */
      div.tooltip {
          color: #222;
          background-color: #fff;
          padding: .5em;
          text-shadow: #f5f5f5 0 1px 0;
          border-radius: 2px;
          opacity: 0.9;
          position: absolute;
      }

      /* le changement d'echelle des maps */
      #scalediv {
          margin-right :50px;
          margin-left :50px;
          margin-top : 50px;
          border : 1pt solid black;
          padding: 5px;
          width : 150px;
      }

      #scale{
          font-size: 20px;
          font-weight: bold;
          margin: 5px;
          max-width : 90px;
      }

      #scaleBtn{
          font-size: 16px;
          padding : 5px;
          margin : 5px;
      }

      /* le div qui contient le slider pour changer le jour */
      #daydiv {
          width : 250px;
          margin-right :50px;
          margin-left :50px;
          margin-top : 80px;
      }

      /* le slider de jour */
      .axis path,
      .axis line {
          fill: none;
          stroke: none;
      }
      .axis text {
          font-size: 12px;
          fill: #AAAAAA;
          font-weight: 400;
      }

      /* le titre de la legende (inexistant for the moment) */
      .legendTitle {
          font-size: 14px;
          fill: #4F4F4F;
          font-weight: 300;
      }

      /* les lignes de frontieres */
      path { fill: none; stroke: black;
        z-index: 1;}

      /* le conteneur des deux maps*/
      #mapContainer{
          position: absolute;
          right: 28px;
          width: 75%;
          padding-right : 6px;
          padding-left : 6px;
          margin-left:6px;
      }
      /* le conteneur de config*/
      #settings {
          position:absolute;
          left:28px;
          width: 20%;
      }
      /*le conteneur d'une map*/
      .map{
          display: inline-block;
          text-align: center;
          margin:0px!important;
          padding:0px!important;
      }
      circle{
        position : relative;
        z-index: 999;
      }

  </style>
</head>

<body>

  <div id = "mapContainer">
    <div id="mapEvents" class = "map"></div>
    <div id="mapTweets" class = "map"></div>
  </div>


  <div id = "settings">

    <div id="daydiv">
      <input id="slider" type="range" value="1" min="1" max="120" step="1" />
      <span id="days"></span>
    </div>

    <div id="scalediv">
      <input id="scale" type="text" value ="30000"/>
      <input id="scaleBtn"
             name="updateButton"
             type="button"
             value="update the scale"/>
    </div>

  </div>

  <script>
    var width = 960,
        height = 620;

    var mapWidth = 450;
    var mapHeight =600;

    var svg = d3.select("#mapEvents")
      .append( "svg" ).attr({'width':mapWidth,'height':mapHeight,'class' : 'svgmap'});

    var svg2 = d3.select( "#mapTweets" )
      .append( "svg" ).attr({'width':mapWidth,'height':mapHeight,'class' : 'svgmap'});

    var projection = d3.geo.mercator()
  					.center([-73.935242,40.730610])
  					.scale(30000)
  					.translate([(mapWidth) / 2-40, (mapHeight)/2-75]);

    var path = d3.geo.path()
              .projection(projection);


    var color = d3.scale.linear()
      .interpolate(d3.interpolateHcl)
      .range(["rgb(237,248,233)", "rgb(0,109,44)"]);


    var color2 = d3.scale.linear()
      .interpolate(d3.interpolateHcl)
      .range(["orange", "red"]).domain([0,50]);


    var opacity = d3.scale.linear()
      .interpolate(d3.interpolateHcl)
      .range([0,1]).domain([0,100]);

    var tooltip = d3.select('body').append('div')
                .attr('class', 'hidden tooltip');

 	var days = [];
 	var tweetsdays = [];
    var dayTweet = {};

    var firedivMap = {"8" : "Staten Island", "15" : "Brooklyn", "11" : "Brooklyn",
                      "14" : "Queens", "13" : "Queens", "1" : "Manhattan", "3" : "Manhattan/Harlem",
                       "6" : "Bronx",  "7" : "Bronx" };

    var colordivMap = {"Manhattan/Harlem":	"rgb(255,182,193)","Queens": "rgb(255,255,204)","Staten Island" : "lightgreen", "Brooklyn" : "lightblue", "Manhattan" : "pink", "Bronx" : "whitesmoke"};

    function fillTooltip(d){
      var mouse = d3.mouse(svg.node()).map(function(d) {
          return parseInt(d);
      });
      var toDisplay =  firedivMap[d.properties.firediv] ;
        
      tooltip.classed('hidden', false)
          .attr('style', 'left:' + (mouse[0] + 15) +
                  'px; top:' + (mouse[1] - 35) + 'px')
          .html(toDisplay);
	 }

     function fillTooltip2(d){
      var mouse = d3.mouse(svg.node()).map(function(d) {
          return parseInt(d);
      });
      var toDisplay =  "User number  : " +  d.userNumber + "</br>"
                     + "Tweets number  : " +  d.tweetsNumbert + "</br>"
                     + "Hashtags  : " +  d.importantHashtags;

      tooltip.classed('hidden', false)
          .attr('style', 'left:' + (mouse[0] + 15) +
                  'px; top:' + (mouse[1] - 35) + 'px')
          .html(toDisplay);
	 }
	function create_date(tweet){
      return tweet.timestamp_year+"-"+tweet.timestamp_month+"-"+tweet.timestamp_day;
    }

    function fillRegions(d, currentDay){
      return colordivMap[firedivMap[d.properties.firediv]];
	}

 	function updateViz(value, data, events, tweets){
		d3.select('#days').html(days[value-1]);
		drawMap(value-1, data, events, tweets);
	}

	function updateScale(value, regions, events,tweets){


      projection = d3.geo.mercator()
                      .center([-73.935242,40.730610])
                      .scale(value)
                      .translate([(mapWidth) / 2-40, (mapHeight)/2-20]);

      path = d3.geo.path()
                .projection(projection);


      svg.selectAll(".state").remove();
      svg2.selectAll(".state2").remove();


      var day = +d3.select('#slider')[0][0].value;
      drawMap(day, regions,events,tweets)
    }

	function drawMap(currentDay, nyc, events) {

      //var map = topojson.feature(nyc, nyc.objects.cty036);
      //console.log(map);

      var carte = svg.selectAll(".state")
	    .data(nyc.features);
       //.datum(topojson.mesh(nyc, nyc.arcs));

	  /*carte.attr("class", "update regions")
            .style("fill", function(d) {
                //console.log("ici");
                var color = fillRegions(d,currentDay);
                return color;
                //return "whitesmoke";
              })
               .on('mousemove', function(d) {
                  fillTooltip(d);
              })
              .on('mouseout', function() {
                  tooltip.classed('hidden', true);
              });*/

	  carte.enter()
          .append("path")
          .attr({
              "d":path,
              "id":function(d){
                  return "mappath1";
              },
              "class":function(d){
                  return "enter regions state " + d.properties.firediv;
              }
          })
          .style("fill", function(d) {
          	var color = fillRegions(d,currentDay);
            return color;
          })
           .style("stroke", "black")
           .style("stroke-width", "1px")
           .on('mousemove', function(d) {
              fillTooltip(d);
            })
            .on('mouseout', function() {
                tooltip.classed('hidden', true);
            });

      carte.exit().remove();

      events = events.filter(function(e) {
        return e.date.split(" ")[0] === d3.select('#days').html();
      });

      var nodes = svg.selectAll(".circles")
          .data(events);

      nodes.attr('class', 'update circles')
            .attr("r", function(d) {
                var totPixels = (width * height);
                var totWorldMeters = 510000000000;
                var metersPerPixel = (totWorldMeters / totPixels);
                var scaledRadius;

                //scale the radius given in meters to pixels on the map
                scaledRadius = (100 * (d.radius/ metersPerPixel));
                if(scaledRadius < 5) {
                    scaledRadius = 5;
                }
                return scaledRadius;
              })
            .attr("transform", function(d) {
              return "translate(" + projection([
                d.position.split(";")[0],
                d.position.split(";")[1]
              ]) + ")";
            })
            .style("fill", function(d) {
                return color2(d.userNumber);
            })
            .style( "opacity", function(d) {
                return opacity(d.tweetsNumbert);
            })
            .on('mousemove', function(d) {
                fillTooltip2(d);
            })
            .on('mouseout', function() {
                tooltip.classed('hidden', true);
            });

      nodes.enter()
              .append('circle')
              .attr('class', 'enter circles')
              .attr("r", function(d) {
                var totPixels = (width * height);
                var totWorldMeters = 510000000000;
                var metersPerPixel = (totWorldMeters / totPixels);
                var scaledRadius;

                //scale the radius given in meters to pixels on the map
                scaledRadius = (100 * (d.radius / metersPerPixel));
                if(scaledRadius < 5) {
                    scaledRadius = 5;
                }
                return scaledRadius;
              })
              .attr("transform", function(d) {
                return "translate(" + projection([
                  d.position.split(";")[0],
                  d.position.split(";")[1]
                ]) + ")";
              })
              .style("fill", function(d) {
                  return color2(d.userNumber);
              })
              .style( "opacity", function(d) {
                  return opacity(d.tweetsNumbert);
              })
              .on('mousemove', function(d) {
                  fillTooltip2(d);
              })
              .on('mouseout', function() {
                  tooltip.classed('hidden', true);
              });

      nodes.exit().remove();

      /*SECOND MAP */
      var carte2 = svg2.selectAll(".state2")
      .data(nyc.features);

      carte2.enter()
        .append("path")
        .attr({
            "d":path,
            "id":function(d){
                return "mappath2";
            },
            "class":function(d){
                return "enter regions state2 " + d.properties.firediv;
            }
        })
        .style("fill", function(d) {
           var color = fillRegions(d,currentDay);
           return color;
        })
        .style("stroke", "black")
        .style("stroke-width", "1px")
        .on('mousemove', function(d) {
          //fillTooltip(d);
        })
        .on('mouseout', function() {
          //tooltip.classed('hidden', true);
        });

      carte2.exit().remove();

      var date = tweetsdays[currentDay];
      //console.log(dayTweet);
      //console.log(date);


      //console.log(dayTweet[date]);

      var nodes2 = svg2.selectAll(".tweets")
        .data(dayTweet[date]);

      nodes2.attr({
            "class":function(d){
                return "update circles";
            },
            "r" : 2,
            "transform" : function(d) {
              if (d.geo_lat == "null") {
                return;
              }
              return "translate(" + projection([
                d.geo_lat,
                d.geo_lng
                ]) + ")";
            }
          })
          .on('mousemove', function(d) {
            //fillTooltipContent(d);
          })
          .on('mouseout', function() {
            //tooltip.classed('hidden', true);
          });

      nodes2.enter()
            .append('circle')
            .attr({
            "class":function(d){
                return "enter circles";
            },
            "r" : 2,
            "transform" : function(d) {
                if (d.geo_lat == "null") {
                  return;
                }
                return "translate(" + projection([
                  d.geo_lat,
                  d.geo_lng
                  ]) + ")";
              }
            })
            .on('mousemove', function(d) {
              //fillTooltip2(d);
            })
            .on('mouseout', function() {
              //tooltip.classed('hidden', true);
            });

      nodes2.exit().remove();
	}

	var scale = 30000;

	function processData(error,regionsdata,eventsData, tweets) {

		if (error) throw  error;

		scale = d3.select('#scale')[0][0].value;

		var nbDays=0;
		var i =0;
        //console.log(eventsData);
        eventsData.forEach(function(event) {
        	var day = event.date.split(" ")[0];
        	if (!days.includes(day)){
        		days.push(day);
        		nbDays++;
        	}
        	i++;
        });
        var nbDays=0;

         //console.log(eventsData);
        /*
	      Object { id: "644543444195614720", timestamp_minute: "8", timestamp_hour: "12", timestamp_day: "17", timestamp_month: "9", timestamp_year: "2015", geo_lat: "null", geo_lng: "null", place_id: "011add077f4d2da3", text: "@rodhinos @haaretzcom", 9 more… }
	    */
        tweets.forEach(function(tweet) {
        	var day = create_date(tweet);
        	if (!tweetsdays.includes(day)){
        		tweetsdays.push(day);
        		nbDays++;
        	}
        	if(!dayTweet[day]){
        		dayTweet[day] = [];
        	}
        	dayTweet[day].push(tweet);
        });

        drawMap(1, regionsdata, eventsData,tweets);
		d3.select('#days').html(days[0]);

		//color.domain([0, d3.max(data, function(d) { return parseFloat(d["somme2014"]);})]);
		d3.select("#slider").on("input", function() {
			updateViz(+this.value, regionsdata, eventsData,tweets);
		});

		d3.select("#scaleBtn").on("click", function() {
			updateScale(+d3.select('#scale')[0][0].value, regionsdata, eventsData,tweets);
		});
	}

	queue()
      // chargement du fichier des district de ny
	  .defer(d3.json, "ny_firedivisions.json")
      //.defer(d3.json, "nyTopo.json")
      //chargement des evenements geolocalise de tweets
	  .defer(d3.csv, "vizuFile.csv")
      //chargement des données de tweets
	  .defer(d3.csv, "smallTweets3.csv")
	  .await(processData);  
  
  </script>

</body>
